<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ–Ω–Ω–∏—Å–Ω—ã–µ –∫–æ—Ä—Ç—ã –ú–æ—Å–∫–≤—ã</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 90vh;
        }
        #controls {
            text-align: center;
            padding: 10px;
        }
        button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="controls">
    <button onclick="getLocation()">üìç –ù–∞–π—Ç–∏ –º–µ–Ω—è</button>
    <label>
        <input type="checkbox" id="filter-courts" onclick="toggleFilter()"> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –±–ª–∏–∂–∞–π—à–∏–µ –∫–æ—Ä—Ç—ã
    </label>
</div>
<div id="map"></div>

    <script>
    var map = L.map('map').setView([55.751244, 37.618423], 11); // –ú–æ—Å–∫–≤–∞

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var courts = [
        { name: "–ü–∞—Ä–∫ –ì–æ—Ä—å–∫–æ–≥–æ", lat: 55.7308, lon: 37.6034, info: "–û—Ç–∫—Ä—ã—Ç—ã–π –∫–æ—Ä—Ç, –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, –æ—Å–≤–µ—â–µ–Ω–∏–µ." },
        { name: "–õ—É–∂–Ω–∏–∫–∏", lat: 55.7158, lon: 37.5537, info: "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–æ—Ä—Ç—ã, –µ—Å—Ç—å —Ä–∞–∑–¥–µ–≤–∞–ª–∫–∏." },
        { name: "–°–æ–∫–æ–ª—å–Ω–∏–∫–∏", lat: 55.7942, lon: 37.6742, info: "–û—Ç–∫—Ä—ã—Ç—ã–µ –∫–æ—Ä—Ç—ã, –º—è–≥–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ." },
        { name: "–§–∏–ª–µ–≤—Å–∫–∏–π –ø–∞—Ä–∫", lat: 55.7451, lon: 37.4673, info: "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–æ—Ä—Ç—ã, –¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç." }
    ];

    var userMarker;
    var courtMarkers = [];

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–æ—Ä—Ç—ã
    function addCourts(filteredCourts = courts) {
        courtMarkers.forEach(marker => map.removeLayer(marker)); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∫–∏
        courtMarkers = [];

        filteredCourts.forEach(court => {
            let marker = L.marker([court.lat, court.lon])
                .addTo(map)
                .bindPopup(`<b>${court.name}</b><br>${court.info}<br><a href="court.html?name=${court.name}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>`);
            courtMarkers.push(marker);
        });
    }

    addCourts(); // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–æ—Ä—Ç—ã

    // üìç –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;

                if (userMarker) {
                    map.removeLayer(userMarker);
                }

                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                map.setView([userLat, userLon], 14);

                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                userMarker = L.marker([userLat, userLon], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png', iconSize: [30, 30] }) })
                    .addTo(map)
                    .bindPopup("–í—ã –∑–¥–µ—Å—å! üìç").openPopup();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ–∫–±–æ–∫—Å
                if (document.getElementById("filter-courts").checked) {
                    filterCourts(userLat, userLon);
                }

            }, error => {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: " + error.message);
            });
        } else {
            alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º");
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ –•–∞–≤–µ—Ä—Å–∏–Ω–∞)
    function getDistance(lat1, lon1, lat2, lon2) {
        function toRad(value) {
            return value * Math.PI / 180;
        }

        const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–º
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ—Ä—Ç–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ 5 –∫–º
    function filterCourts(userLat, userLon) {
        let filteredCourts = courts.filter(court => getDistance(userLat, userLon, court.lat, court.lon) <= 5);
        addCourts(filteredCourts);
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
    function toggleFilter() {
        if (userMarker) {
            const userLat = userMarker.getLatLng().lat;
            const userLon = userMarker.getLatLng().lng;
            if (document.getElementById("filter-courts").checked) {
                filterCourts(userLat, userLon);
            } else {
                addCourts();
            }
        }
    }

    // üìç –ï—Å–ª–∏ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ –Ω–µ–≥–æ
    if (window.Telegram && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
        Telegram.WebApp.expand();
        Telegram.WebApp.ready();

        Telegram.WebApp.requestGeoLocation((location) => {
            if (location) {
                const userLat = location.latitude;
                const userLon = location.longitude;
                map.setView([userLat, userLon], 14);

                userMarker = L.marker([userLat, userLon], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png', iconSize: [30, 30] }) })
                    .addTo(map)
                    .bindPopup("–í—ã –∑–¥–µ—Å—å! üìç").openPopup();

                if (document.getElementById("filter-courts").checked) {
                    filterCourts(userLat, userLon);
                }
            }
        });
    }

</script>

</body>
</html>
