<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ–Ω–Ω–∏—Å–Ω—ã–µ –∫–æ—Ä—Ç—ã –ú–æ—Å–∫–≤—ã</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ‚úÖ –î–µ–ª–∞–µ–º —Ñ–æ–Ω –±–µ–ª—ã–º –≤–µ–∑–¥–µ */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: white !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –±–µ–ª—ã–π —Ñ–æ–Ω */
            color: black; /* –ß–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
            font-family: Arial, sans-serif;
        }

        /* ‚úÖ –î–µ–ª–∞–µ–º –≤–µ—Ä—Ö–Ω—é—é –ø–∞–Ω–µ–ª—å –±–µ–ª–æ–π */
        #controls {
            text-align: center;
            padding: 10px;
            background: white !important; /* –ë–µ–ª—ã–π —Ñ–æ–Ω –ø–∞–Ω–µ–ª–∏ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            border-bottom: 1px solid #ccc; /* –¢–æ–Ω–∫–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
        }

        /* ‚úÖ –ö–∞—Ä—Ç–∞ —Å –æ—Ç—Å—Ç—É–ø–æ–º –æ—Ç –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
        #map {
            width: 100%;
            height: calc(100vh - 50px);
            margin-top: 50px; /* –û—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –ø–∞–Ω–µ–ª—å –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞ –∫–∞—Ä—Ç—É */
        }

        /* ‚úÖ –ö–Ω–æ–ø–∫–∏ */
        button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        /* ‚úÖ –ß–µ–∫–±–æ–∫—Å */
        label {
            font-size: 16px;
            color: black; /* –ß–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
        }
    </style>
</head>
<body>

    <!-- ‚úÖ Telegram Web App API -->
    <script>
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º Web App –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            Telegram.WebApp.ready();
            Telegram.WebApp.setBackgroundColor("#FFFFFF"); // –§–∏–∫—Å–∏—Ä—É–µ–º –±–µ–ª—ã–π —Ñ–æ–Ω
            Telegram.WebApp.setHeaderColor("#FFFFFF"); // –§–∏–∫—Å–∏—Ä—É–µ–º –±–µ–ª—É—é –≤–µ—Ä—Ö–Ω—é—é –ø–∞–Ω–µ–ª—å
        }
    </script>

    <div id="controls">
        <button onclick="getLocation()">üìç –ù–∞–π—Ç–∏ –º–µ–Ω—è</button>
        <label>
            <input type="checkbox" id="filter-courts" onclick="toggleFilter()"> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –±–ª–∏–∂–∞–π—à–∏–µ –∫–æ—Ä—Ç—ã
        </label>
        <select id="surface-filter" onchange="applyFilters()">
    <option value="all">–õ—é–±–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ</option>
    <option value="hard">–•–∞—Ä–¥</option>
    <option value="clay">–ì—Ä—É–Ω—Ç</option>
    <option value="grass">–¢—Ä–∞–≤–∞</option>
</select>

<label>
    <input type="checkbox" id="lights-filter" onclick="applyFilters()"> –û—Å–≤–µ—â–µ–Ω–∏–µ
</label>

<label>
    <input type="checkbox" id="locker-filter" onclick="applyFilters()"> –†–∞–∑–¥–µ–≤–∞–ª–∫–∏
</label>
    </div>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([55.751244, 37.618423], 11); // –ú–æ—Å–∫–≤–∞

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var courts = [
    { name: "–ü–∞—Ä–∫ –ì–æ—Ä—å–∫–æ–≥–æ", lat: 55.7308, lon: 37.6034, info: "–û—Ç–∫—Ä—ã—Ç—ã–π –∫–æ—Ä—Ç", surface: "hard", lights: true, locker: false },
    { name: "–õ—É–∂–Ω–∏–∫–∏", lat: 55.7158, lon: 37.5537, info: "–ö—Ä—ã—Ç—ã–µ –∫–æ—Ä—Ç—ã", surface: "clay", lights: true, locker: true },
    { name: "–°–æ–∫–æ–ª—å–Ω–∏–∫–∏", lat: 55.7942, lon: 37.6742, info: "–û—Ç–∫—Ä—ã—Ç—ã–µ –∫–æ—Ä—Ç—ã", surface: "grass", lights: false, locker: false },
    { name: "–§–∏–ª–µ–≤—Å–∫–∏–π –ø–∞—Ä–∫", lat: 55.7451, lon: 37.4673, info: "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–æ—Ä—Ç—ã", surface: "hard", lights: true, locker: true }
];

        var userMarker;
        var courtMarkers = [];

        function addCourts(filteredCourts = courts) {
            courtMarkers.forEach(marker => map.removeLayer(marker));
            courtMarkers = [];

            filteredCourts.forEach(court => {
                let marker = L.marker([court.lat, court.lon])
                    .addTo(map)
                    .bindPopup(`<b>${court.name}</b><br>${court.info}<br><a href="court.html?name=${court.name}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>`);
                courtMarkers.push(marker);
            });
        }

        addCourts();

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    map.setView([userLat, userLon], 14);

                    userMarker = L.marker([userLat, userLon], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png', iconSize: [30, 30] }) })
                        .addTo(map)
                        .bindPopup("–í—ã –∑–¥–µ—Å—å! üìç").openPopup();

                    if (document.getElementById("filter-courts").checked) {
                        filterCourts(userLat, userLon);
                    }

                }, error => {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: " + error.message);
                });
            } else {
                alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º");
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            function toRad(value) {
                return value * Math.PI / 180;
            }

            const R = 6371;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function filterCourts(userLat, userLon) {
            let filteredCourts = courts.filter(court => getDistance(userLat, userLon, court.lat, court.lon) <= 5);
            addCourts(filteredCourts);
        }

        function toggleFilter() {
            if (userMarker) {
                const userLat = userMarker.getLatLng().lat;
                const userLon = userMarker.getLatLng().lng;
                if (document.getElementById("filter-courts").checked) {
                    filterCourts(userLat, userLon);
                } else {
                    addCourts();
                }
            }
        }
        function applyFilters() {
    let selectedSurface = document.getElementById("surface-filter").value;
    let filterLights = document.getElementById("lights-filter").checked;
    let filterLocker = document.getElementById("locker-filter").checked;

    let filteredCourts = courts.filter(court => {
        let matchesSurface = (selectedSurface === "all" || court.surface === selectedSurface);
        let matchesLights = (!filterLights || court.lights);
        let matchesLocker = (!filterLocker || court.locker);
        return matchesSurface && matchesLights && matchesLocker;
    });

    addCourts(filteredCourts);
}
        function addCourts(filteredCourts = courts) {
    courtMarkers.forEach(marker => map.removeLayer(marker));
    courtMarkers = [];

    filteredCourts.forEach(court => {
        let marker = L.marker([court.lat, court.lon])
            .addTo(map)
            .bindPopup(`<b>${court.name}</b><br>${court.info}<br><b>–ü–æ–∫—Ä—ã—Ç–∏–µ:</b> ${court.surface}<br><b>–û—Å–≤–µ—â–µ–Ω–∏–µ:</b> ${court.lights ? "–ï—Å—Ç—å" : "–ù–µ—Ç"}<br><b>–†–∞–∑–¥–µ–≤–∞–ª–∫–∏:</b> ${court.locker ? "–ï—Å—Ç—å" : "–ù–µ—Ç"}<br><a href="court.html?name=${court.name}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>`);
        courtMarkers.push(marker);
    });
}

        if (window.Telegram && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
            Telegram.WebApp.expand();
            Telegram.WebApp.ready();

            Telegram.WebApp.requestGeoLocation((location) => {
                if (location) {
                    const userLat = location.latitude;
                    const userLon = location.longitude;
                    map.setView([userLat, userLon], 14);

                    userMarker = L.marker([userLat, userLon], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png', iconSize: [30, 30] }) })
                        .addTo(map)
                        .bindPopup("–í—ã –∑–¥–µ—Å—å! üìç").openPopup();

                    if (document.getElementById("filter-courts").checked) {
                        filterCourts(userLat, userLon);
                    }
                }
            });
        }
    </script>

</body>
</html>
